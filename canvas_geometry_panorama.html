<!DOCTYPE html>
<html lang="en">
	<head>
		<title>three.js canvas - panorama demo</title>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
		<style>
			body {
				background-color: rgb(200,200,200);
				margin: 0px;
				overflow: hidden;
			}

			#info {
				position: absolute;
				top: 0px; width: 100%;
				color: #ffffff;
				padding: 5px;
				font-family:Monospace;
				font-size:13px;
				font-weight: bold;
				text-align:center;
			}

			a {
				color: #ffffff;
			}
			
		</style>
	</head>
	<body>

		<div id="container"></div>
		<div id="info"><a href="http://threejs.org" target="_blank">three.js</a> - panorama demo. texture by <a href="http://www.humus.name/index.php?page=Textures" target="_blank">Humus</a>.

		Select background:
		<select id="backgroundList" onchange="onChangeBackground()">
		  <option value="ArstaBridge">Arsta Bridge</option>
		  <option value="ForbiddenCity">Forbidden City</option>  
		  <option value="GamlaStan">Gamla Stan</option>
		  <option value="IceRiver">Ice River</option>
		  <option value="Maskonaive3">Maskonaive</option>
		  <option value="NissiBeach2">Nissi Beach</option>
		  <option value="Park2">Park</option>
		  <option value="Park3Med">Park Med</option>
		  <option value="PereaBeach2">Perea Beach</option>
		  <option value="Ryfjallet">Ryfjallet</option>
		  <option value="SaintPetersSquare1">Saint Peters Square</option>
		  <option value="Skansen3" selected="selected">Skansen3</option>
		  <option value="Skansen4">Skansen4</option>
		  <option value="Skinnarviksberget">Skinnarviksberget</option>
		  <option value="Stairs">Stairs</option>
		  <option value="Tenerife3">Tenerife</option>
		</select>
		</div>

		<script src="./build/three.min.js"></script>

		<script>

			var camera, scene, renderer;

			var texture_placeholder,
			isUserInteracting = false,
			onMouseDownMouseX = 0, onMouseDownMouseY = 0,
			lon = 90, onMouseDownLon = 0,
			lat = 0, onMouseDownLat = 0,
			phi = 0, theta = 0,
			target = new THREE.Vector3();
			var mesh, format, path;

			init();

			function init() {

				var container;

				container = document.getElementById( 'container' );

				camera = new THREE.PerspectiveCamera( 75, window.innerWidth / window.innerHeight, 1, 1100 );

				scene = new THREE.Scene();

				texture_placeholder = document.createElement( 'canvas' );
				texture_placeholder.width = 128;
				texture_placeholder.height = 128;

				var context = texture_placeholder.getContext( '2d' );
				context.fillStyle = 'rgb( 200, 200, 200 )';
				context.fillRect( 0, 0, texture_placeholder.width, texture_placeholder.height);

				path = "textures/cube/Skansen3/";
				format = '.jpg';

				var materials = [

					loadTexture( path + 'posx' + format ), // right
					loadTexture( path + 'negx' + format ), // left
					loadTexture( path + 'posy' + format ), // top
					loadTexture( path + 'negy' + format  ), // bottom
					loadTexture( path + 'posz' + format ), // back
					loadTexture( path + 'negz' + format )  // front

				];

				mesh = new THREE.Mesh( new THREE.CubeGeometry( 300, 300, 300, 7, 7, 7 ), new THREE.MeshFaceMaterial( materials ) );
				mesh.scale.x = - 1;
				scene.add( mesh );
				//~ scene.remove( mesh );


				renderer = new THREE.CanvasRenderer();
				renderer.setSize( window.innerWidth, window.innerHeight );

				container.appendChild( renderer.domElement );

				document.addEventListener( 'mousedown', onDocumentMouseDown, false );
				document.addEventListener( 'mousemove', onDocumentMouseMove, false );
				document.addEventListener( 'mouseup', onDocumentMouseUp, false );
				document.addEventListener( 'mousewheel', onDocumentMouseWheel, false );

				document.addEventListener( 'touchstart', onDocumentTouchStart, false );
				document.addEventListener( 'touchmove', onDocumentTouchMove, false );

				//

				window.addEventListener( 'resize', onWindowResize, false );

			}

			function onChangeBackground() {
				var listBox = document.getElementById("backgroundList");	
			        var strBackground = listBox.options[listBox.selectedIndex].value;
				var newPath = "textures/cube/" + strBackground + "/";
				
				if(newPath !== path){
					scene.remove(mesh);
					render();

					path = newPath;
					format = '.jpg';
					var posPrefix = "p";
					var negPrefix = "n";
					
					switch(strBackground){
					    case "ArstaBridge":
					    case "ForbiddenCity":
					    case "GamlaStan":
					    case "IceRiver":
					    case "Maskonaive3":
					    case "NissiBeach2":
					    case "Park2":
					    case "PereaBeach2":
					    case "Ryfjallet":
					    case "SaintPetersSquare1":
					    case "Skansen3":
					    case "Skansen4":
					    case "Skinnarviksberget":
					    case "Stairs":
					    case "Tenerife3":
					        posPrefix = "pos";
					        negPrefix = "neg";
					        break;
					}
					
					var materials = [
						loadTexture( path + posPrefix + 'x' + format ), // right
						loadTexture( path + negPrefix + 'x' + format ), // left
						loadTexture( path + posPrefix + 'y' + format ), // top
						loadTexture( path + negPrefix + 'y' + format  ), // bottom
						loadTexture( path + posPrefix + 'z' + format ), // back
						loadTexture( path + negPrefix + 'z' + format )  // front
					];

					mesh = new THREE.Mesh( new THREE.CubeGeometry( 300, 300, 300, 7, 7, 7 ), new THREE.MeshFaceMaterial( materials ) );
					mesh.scale.x = - 1;

					scene.add( mesh );

					render();
				}
			}

			function onWindowResize() {

				camera.aspect = window.innerWidth / window.innerHeight;
				camera.updateProjectionMatrix();

				renderer.setSize( window.innerWidth, window.innerHeight );

				render();

			}

			function loadTexture( path ) {

				var texture = new THREE.Texture( texture_placeholder );
				var material = new THREE.MeshBasicMaterial( { map: texture, overdraw: true } );

				var image = new Image();
				image.onload = function () {

					texture.needsUpdate = true;
					material.map.image = this;

					render();

				};
				image.src = path;

				return material;

			}

			function onDocumentMouseDown( event ) {

				//~ event.preventDefault();

				isUserInteracting = true;

				onPointerDownPointerX = event.clientX;
				onPointerDownPointerY = event.clientY;

				onPointerDownLon = lon;
				onPointerDownLat = lat;

			}

			function onDocumentMouseMove( event ) {

				if ( isUserInteracting ) {

					lon = ( onPointerDownPointerX - event.clientX ) * 0.1 + onPointerDownLon;
					lat = ( event.clientY - onPointerDownPointerY ) * 0.1 + onPointerDownLat;
					render();

				}

			}

			function onDocumentMouseUp( event ) {

				isUserInteracting = false;
				render();

			}

			function onDocumentMouseWheel( event ) {

				camera.fov -= event.wheelDeltaY * 0.05;
				camera.updateProjectionMatrix();

				render();

			}


			function onDocumentTouchStart( event ) {

				if ( event.touches.length == 1 ) {

					//~ event.preventDefault();

					onPointerDownPointerX = event.touches[ 0 ].pageX;
					onPointerDownPointerY = event.touches[ 0 ].pageY;

					onPointerDownLon = lon;
					onPointerDownLat = lat;

				}

			}

			function onDocumentTouchMove( event ) {

				if ( event.touches.length == 1 ) {

					event.preventDefault();

					lon = ( onPointerDownPointerX - event.touches[0].pageX ) * 0.1 + onPointerDownLon;
					lat = ( event.touches[0].pageY - onPointerDownPointerY ) * 0.1 + onPointerDownLat;

					render();

				}

			}

			function render() {

				lat = Math.max( - 85, Math.min( 85, lat ) );
				phi = THREE.Math.degToRad( 90 - lat );
				theta = THREE.Math.degToRad( lon );

				target.x = 500 * Math.sin( phi ) * Math.cos( theta );
				target.y = 500 * Math.cos( phi );
				target.z = 500 * Math.sin( phi ) * Math.sin( theta );

				camera.lookAt( target );

				renderer.render( scene, camera );

			}

		</script>
	</body>
</html>
